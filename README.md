# Ensembles_detection_calcium_imaging

This repository includes the functions used to detect neuronal ensembles based on above chance activity, principal component analysis and clustering. This requires extracted and denoided calcium imaging signals from several regions of interest. For extraction and denoising you can check this [repository](https://github.com/shehab-elzoheiry/Extraction_of_Calcium_Imaging_Signals)

This work is part of the publication [Elzoheiry et al 2019](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7820691/pdf/10.1177_0271678X19892657.pdf). Check the publication for more details. Below is part of the methods section.

## Explanation:

For detection of synchronised activity, fluorescence transients were smoothed by sliding average window of 1 s. The pre-processed calcium traces were analysed as described before. Fluorescence values (F) of each cell were normalised to their maximum F value across all frames. This yielded values between 0 and 1. As a next step, we identified time points, in which the ensemble activity was above chance. To this end, we first determined a threshold based on randomly shuffled data. F values for each cell were shifted randomly in time in a circular fashion (while maintaining individual cells activity), and the average network activity of each frame was measured. This step was repeated 10,000 times yielding a distribution of average network activities, which reflects randomised activity. From this distribution, we defined the 99th percentile as the threshold for ‘above chance activity’, which is referred to as synchronised activity in the text. Each frame with such synchronised activity is then described by an n-dimensional vector (population vector) containing the normalised F values, where n is the total number of cells. To identify recurring synchronised activity, we determined which of those frames showed similar patterns. To do this, we calculated a similarity matrix for all possible frame pairs. Similarity indices were calculated as the cosine of the angle between the two frame vectors. This yielded values between 0 and 1, where 1 corresponds to perfect similarity. The more similar the set of active cells in the compared events, the higher is the similarity index. Again a threshold for similarity was determined to identify stably recurring synchronised activity over random co-activity. As described above, the threshold was set to the 99th percentile of the similarity distribution of randomised population vectors (shifted randomly 10,000 times). Afterwards, calcium transients were translated to binary output, in which recruited cells at the time points of synchronised activity were translated to logical ones. The output is population vectors in binary code. These vectors were then categorised by principal component analysis, followed by clustering using Fuzzy C-means and Dunn’s index into ensembles of pyramidal cells.

## Implementation on local machine:

* First, run Ensembles_Detection.m function on denoised calcium fluorescent signal.
This script is based on bootstrapping apporach to detect above chance level coincident Ca++ imaging signals based on Hamm et al., Neuron 2017. This is combined effort from Shehabeldin Elzoheiry: shehab.elzohairy@gmail.com & Juan C. Boffi: boffi@ana.uni-heidelberg.de

* Second, run PCA_Clustering_Ensembles.m 
This script is based on principal component analysis, which aims to present population vectors in multidimensional space. Followed by reducing the dimensions to 3 and then applying k-means clustering to group population vectors that are closest to one another. These groups are considered to be different time points of activation of detected ensembles.

* The remaining functions are helping functions, you don't need to run them separetely for any step of the analysis.
